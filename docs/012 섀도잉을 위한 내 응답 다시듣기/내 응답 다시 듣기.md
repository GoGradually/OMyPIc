# 내 응답 다시 듣기 계획 문서

## 1. 목적

사용자가 방금 말한 자신의 답변을 다시 들으면서 섀도잉할 수 있도록, "직전 마지막 사용자 응답 재생/중지" 기능을 제공한다.

---

## 2. 계획 이력 정리

### 2.1 초기 계획 (기본 기능 정의)

1. 세션 시작/종료 버튼이 있는 줄의 오른쪽에 재생/중지 버튼 배치.
2. 사용자는 재생 버튼으로 직전 응답을 듣고, 중지 버튼으로 멈춤.

### 2.2 보완 계획 (재연결/이어붙이기 고려)

1. 기존 오디오 파이프의 이어붙이기 결과를 재활용 가능한지 검토.
2. 재연결 시 파이프 끊김 이력이 있어도 마지막 응답 재생 품질을 보장할 수 있는지 검토.
3. 질문 컨텍스트 불일치, STT 실패(`stt.skipped`) 케이스의 처리 규칙 추가.

### 2.3 최종 방향 (기존 기능 안전성 우선)

1. 기존 STT/VAD/TTS/재연결 파이프의 핵심 동작은 변경하지 않는다.
2. 다시듣기 기능은 기존 파이프와 분리된 보조 상태로 추가한다.
3. 세션 중에는 제한된 안전 구간에서만 재생 허용한다.

---

## 3. 코드 검토로 확인된 사실

1. 기존 "이어붙이기"는 텍스트가 아니라 PCM16 오디오 바이트(`Uint8Array`)를 합치는 로직이다.
2. 현재 이어붙인 오디오는 재생용이 아니라 서버 업로드/재연결 복구용으로 사용된다.
3. `stt.final`, `question.prompt`, `stt.skipped` 이벤트에는 `turnId`가 포함되어 있으며, 이를 이용하면 오디오-전사 매칭 안정성을 높일 수 있다.

---

## 4. 최종 결정 사항

### 4.1 재생 소스

1. 마지막 사용자 응답의 "실제 녹음본(PCM16)"을 사용한다.
2. STT 텍스트를 다시 TTS로 합성하는 방식은 사용하지 않는다.

### 4.2 버튼 활성 조건

1. `confirmed` 상태의 마지막 응답 오디오가 있을 때만 활성화한다.
2. 세션 종료 후에도 `confirmed` 오디오가 남아 있으면 재생 가능하다.

### 4.3 세션 중 허용 구간

1. `stt.final`이 완료된 후부터 다음 `tts.audio` 도착 전까지 허용한다.
2. 동시에 `speechState === WAITING_TTS` 또는 `speechState === READY_FOR_ANSWER` 조건을 만족해야 한다.
3. `speechState === READY_FOR_ANSWER`에서 재생을 시작하는 경우, 재생 중 마이크 캡처는 임시 차단해야 한다.

### 4.4 충돌 정책

1. `CAPTURING_ANSWER` 중에는 다시듣기 재생 금지.
2. 다시듣기 재생 중 새 `tts.audio`가 도착하면, TTS를 큐에 대기시키고 다시듣기 완료 후 순차 재생.

### 4.5 재연결/불일치 정책

1. 질문 컨텍스트 불일치로 현재 턴 오디오가 폐기될 경우, 직전 `confirmed` 오디오는 유지한다.
2. `stt.skipped(empty_transcript)` 턴은 다시듣기 확정 대상으로 인정하지 않는다.

### 4.6 세션 중 재생 길이

1. 세션 중에도 전체 길이 재생을 허용한다.

---

## 5. 안전 구현 원칙 (기존 기능 무영향 기준)

1. 기존 `speechState` 전이 규칙은 수정하지 않는다.
2. 기존 업로드 버퍼(`pending`, `inFlight`)는 재생 로직에서 직접 변경하지 않는다.
3. 다시듣기 상태는 별도 상태(`replayState`)로 관리한다.
4. 기존 상수(VAD 임계값, 최대 턴 길이, 재연결 재시도)는 변경하지 않는다.
5. `READY_FOR_ANSWER`에서 다시듣기 재생 시 `capture block` 가드를 켜서 입력 수집을 막고, 재생 종료/중단 시 즉시 해제한다.

---

## 6. 데이터 모델 (문서 기준)

### 6.1 ReplayAudioCandidate

1. `turnId: number`
2. `questionId: string`
3. `sampleRate: number`
4. `pcm16Bytes: Uint8Array`
5. `capturedAt: number`

### 6.2 ReplayAudioConfirmed

1. `turnId: number`
2. `questionId: string`
3. `sampleRate: number`
4. `pcm16Bytes: Uint8Array`
5. `confirmedAt: number`
6. `confirmedBy: 'stt.final'`

### 6.3 보관 정책

1. `candidate` 1개, `confirmed` 1개만 유지한다.
2. 새 `confirmed`가 확정되면 기존 `confirmed`는 교체한다.

---

## 7. 상세 동작 흐름

1. `flushPendingAudio`에서 merged PCM 생성 시 `candidate`를 갱신한다.
2. `stt.final(turnId)` 수신 시 `candidate.turnId === turnId`일 때 `confirmed`로 승격한다.
3. `stt.skipped(turnId)` 수신 시 해당 턴 `candidate`는 폐기한다.
4. 재생 시작 가능 상태는 `WAITING_TTS` 또는 `READY_FOR_ANSWER`로 제한한다.
5. `READY_FOR_ANSWER`에서 재생 시작 시 `capture block` 가드를 활성화한다.
6. 다시듣기 재생 시 PCM16 -> WAV 변환 후 `Audio`로 재생한다.
7. 다시듣기 재생 중 도착한 TTS 이벤트는 `deferredTtsQueue`에 저장한다.
8. 다시듣기 종료 즉시 `deferredTtsQueue`를 기존 TTS 큐로 flush한다.
9. 치명 오류(`session.stopped`, `tts.error` 등) 시 다시듣기를 중단하고 기존 세션 종료 흐름을 우선한다.

---

## 8. UI 요구사항

1. 위치: 세션 시작/종료 버튼 행 우측 정렬.
2. 버튼 라벨:
    1. 비재생 시 `내 응답 재생`
    2. 재생 중 `중지`
3. 비활성 사유 문구 예시:
    1. `다시 들을 수 있는 응답이 없습니다.`
    2. `답변을 수집 중에는 다시듣기를 사용할 수 없습니다.`
    3. `새 음성 안내가 도착해 다시듣기를 잠시 종료했습니다.`

---

## 9. 기존 기능 영향 및 대응

1. 위험: 세션 타이밍 지연
    1. 원인: 다시듣기 중 도착 TTS 대기
    2. 대응: 다시듣기 미사용 경로는 기존과 동일, 사용 시에만 지연 허용

2. 위험: 오디오 재수집(하울링)
    1. 원인: 캡처 중 재생
    2. 대응: `CAPTURING_ANSWER`에서 재생 금지

3. 위험: 턴 매칭 오류
    1. 원인: 텍스트와 오디오 확정 시점 불일치
    2. 대응: `turnId` 일치 조건으로만 확정

4. 위험: 메모리 누수
    1. 원인: Blob URL/Audio 핸들러 미정리
    2. 대응: 종료/중지/오류 시 URL revoke + 핸들러 해제

---

## 10. 테스트 계획

### 10.1 회귀 테스트

1. 다시듣기 미사용 시 기존 음성 세션 동작(질문/피드백 순서, STT 수집, 재연결 복구) 동일 유지.
2. 기존 재연결/업로드 재시도 테스트 케이스 통과.

### 10.2 신규 기능 테스트

1. `stt.final` 후 `WAITING_TTS` 또는 `READY_FOR_ANSWER` 상태에서만 재생 가능.
2. `stt.skipped` 턴은 `confirmed`가 생성되지 않음.
3. 재생 중 `tts.audio` 도착 시 즉시 재생되지 않고 대기 큐로 이동.
4. 다시듣기 종료 후 대기 TTS가 순서대로 재생.
5. `CAPTURING_ANSWER` 중 다시듣기 시도 시 재생 금지.
6. 재연결 불일치로 현재 턴 오디오 폐기 시, 직전 `confirmed`는 유지.
7. 세션 종료 후 `confirmed` 존재 시 재생 가능.
8. PCM -> WAV 변환/재생 실패 시 상태 복구 및 사용자 안내.
9. `READY_FOR_ANSWER`에서 재생 시 마이크 캡처가 시작되지 않음을 검증(`capture block` 동작).

---

## 11. 비범위

1. 서버에 사용자 원본 음성 영구 저장/조회 API 추가.
2. 다중 턴 히스토리 목록 재생.
3. 새로고침 이후 다시듣기 오디오 복원.

---

## 12. 구현 반영 결과 (2026-02-19)

### 12.1 구현 완료 항목

1. 세션 액션 행 우측에 `내 응답 재생`/`중지` 버튼 추가.
2. 다시듣기 상태를 `speechState`와 분리된 보조 상태(`replayState`)로 관리.
3. `flushPendingAudio`에서 생성된 merged PCM16을 `candidate`로 저장.
4. `stt.final(turnId)` 수신 시 `candidate.turnId` 일치 조건에서만 `confirmed` 승격.
5. `stt.skipped(turnId)` 수신 시 해당 턴 `candidate` 폐기.
6. 다시듣기 재생 시 PCM16 -> WAV 변환 후 `Audio` 재생.
7. 다시듣기 재생 중 도착한 `tts.audio`는 `deferred` 큐에 보관 후 재생 종료 시 flush.
8. `READY_FOR_ANSWER`에서 재생 시작 시 캡처 차단 가드 적용, 종료 시 즉시 해제.
9. 세션 종료 후 `confirmed` 유지, 새 세션 시작 시 `confirmed` 초기화.
10. 비활성 사유는 버튼 툴팁(`title`)로 노출.

### 12.2 구현 파일

1. `frontend/src/features/voice/hooks/useVoiceLifecycle.js`
2. `frontend/src/features/voice/hooks/bindVoiceEvents.js`
3. `frontend/src/app/hooks/useAppViewModel.js`
4. `frontend/src/features/voice/components/VoicePanel.jsx`
5. `frontend/src/styles/layout.css`
6. `frontend/src/styles/overlay.css`
7. `frontend/src/features/voice/hooks/useVoiceSession.test.jsx`

### 12.3 검증 결과

1. 대상 테스트: `src/features/voice/hooks/useVoiceSession.test.jsx`
    - 결과: 26 tests passed
2. 프론트 전체 테스트: 61 tests passed
3. 프론트 빌드: `vite build` 성공
